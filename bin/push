#!/bin/bash

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Validate command line argument
VALID_BRANCHES=("main" "staging" "production")
TARGET_BRANCH=$1

if [ -z "$TARGET_BRANCH" ]; then
  echo -e "${RED}Error: No target branch specified${NC}"
  echo -e "Usage: $0 <branch>"
  echo -e "Valid branches: ${VALID_BRANCHES[*]}"
  exit 1
fi

# Check if target branch is valid
if [[ ! " ${VALID_BRANCHES[@]} " =~ " ${TARGET_BRANCH} " ]]; then
  echo -e "${RED}Error: Invalid target branch '${TARGET_BRANCH}'${NC}"
  echo -e "Valid branches: ${VALID_BRANCHES[*]}"
  exit 1
fi

# Resolve branch aliases
if [ "$TARGET_BRANCH" = "production" ]; then
  TARGET_BRANCH="main"
fi

# Save the current branch name
CURRENT_BRANCH=$(git branch --show-current)

# Function to exit the script and return to the original branch on error
function exit_with_error {
  echo -e "\n${RED}╔════ ERROR ════╗${NC}"
  echo -e "${RED}$1${NC}"
  echo -e "${RED}╚═══════════════╝${NC}"

  echo -e "\n${YELLOW}Cleaning up...${NC}"
  git merge --abort 2>/dev/null # Abort any incomplete merge
  git checkout "$CURRENT_BRANCH"
  exit 1
}

# Checkout the target branch
echo -e "\n${YELLOW}Switching to ${TARGET_BRANCH} branch...${NC}"
if ! git checkout "$TARGET_BRANCH"; then
  exit_with_error "❌ Failed to switch to ${TARGET_BRANCH} branch!"
fi

# Merge the current branch into the target branch
echo -e "\n${YELLOW}Merging ${CURRENT_BRANCH} into ${TARGET_BRANCH}...${NC}"
if ! git merge --no-edit "$CURRENT_BRANCH"; then
  exit_with_error "❌ Merge conflicts occurred! Aborting merge."
fi

# Push the merge to the remote repository
echo -e "\n${YELLOW}Pushing changes to origin/${TARGET_BRANCH}...${NC}"
if ! git push origin "$TARGET_BRANCH"; then
  exit_with_error "❌ Failed to push changes to origin/${TARGET_BRANCH}!"
fi

# Switch back to the original branch
echo -e "\n${YELLOW}Switching back to ${CURRENT_BRANCH}...${NC}"
if ! git checkout "$CURRENT_BRANCH"; then
  exit_with_error "❌ Failed to switch back to ${CURRENT_BRANCH}!"
fi

echo -e "\n${GREEN}✅ Merge and push to ${TARGET_BRANCH} successful!${NC}\n"
